var mymap=L.map('mapid').setView([40,0],2.8);var popup=L.popup();var idx_m=0;var tab_markers=[];var geocodeService=L.esri.Geocoding.geocodeService();var canPlaceMarker=true;L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(mymap);mymap.locate({setView:true,maxZoom:15});var tmpMarker;var boolAdd=false;function onMapClick(e){boolAdd=true;if(canPlaceMarker){tmpMarker=addMarker(e.latlng.lat,e.latlng.lng);$('#comment-page').show("slow");$('#add-comment').show("slow");canPlaceMarker=false}}var selectedMarker;var boolMod=false;function onMarkerClick(e){boolMod=true;selectedMarker=e.target;if(selectedMarker!=tmpMarker){$('#comment-page').show("slow");$('#modify-comment').show("slow");selectedMarker.getPopup().togglePopup();lat=e.target._latlng.lat;lng=e.target._latlng.lng}}function locationOfUserMarker(e){console.log(e);lat=e.latitude;lng=e.longitude;addMarker(lat,lng)}mymap.on('click',onMapClick);mymap.on('locationfound',locationOfUserMarker);function goTo(a,b){mymap.setView([a,b],17)}function validateComment(a){if(!boolMod)$('#comment-page').hide("slow");$('#add-comment').hide("slow");if(!a){mymap.removeLayer(tmpMarker)}tmpMarker="t";canPlaceMarker=true;boolAdd=false}function modifyComment(a){if(!boolAdd)$('#comment-page').hide("slow");$('#modify-comment').hide("slow");if(!a){mymap.removeLayer(selectedMarker)}selectedMarker="s";boolMod=false}function addMarker(c,d){var e=L.marker(L.latLng(c,d)).addTo(mymap);var f=L.latLng(c,d);tab_markers.push(e);geocodeService.reverse().latlng(f).run(function(a,b){address="";if(b){address+=b.address.Match_addr}else{address+="No address"}e.bindPopup(address).openPopup()});e.on("click",onMarkerClick);return e}function removeMarker(a){mymap.removeLayer(a)}function removeCurrentMarker(){mymap.removeLayer(selectedMarker)}function addr_search(){var e=document.getElementById("addr");$.getJSON('http://nominatim.openstreetmap.org/search?format=json&limit=5&q='+e.value,function(c){var d=[];$.each(c,function(a,b){d.push("<li><a href='#' onclick='chooseAddr("+b.lat+", "+b.lon+");return false;'>"+b.display_name+'</a></li>')})})}function chooseAddr(a,b){var c=new L.LatLng(a,b);mymap.panTo(c)}